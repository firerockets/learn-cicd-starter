on:
  push:
    branches: [main]

jobs:
  deploy:
      name: Deploy
      runs-on: ubuntu-latest
      
      steps:
        - id: 'auth'
          uses: google-github-actions/auth@v2
          with:
            credentials_json: ${{ secrets.GCP_CREDENTIALS }}
            export_credentials: true

        - name: Debug credentials file
          run: |
            echo "GOOGLE_GHA_CREDS_PATH=$GOOGLE_GHA_CREDS_PATH"
            if [ -f "$GOOGLE_GHA_CREDS_PATH" ]; then
              echo "Credentials file exists at $GOOGLE_GHA_CREDS_PATH"
              cat "$GOOGLE_GHA_CREDS_PATH"
            else
              echo "Credentials file does NOT exist at $GOOGLE_GHA_CREDS_PATH"
              ls -la /home/runner/work/learn-cicd-starter/learn-cicd-starter/
            fi

        - name: Check out code
          uses: actions/checkout@v4

        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: "1.23.0"

        - name: Build
          run: scripts/buildprod.sh

        - name: Set up Cloud SDK
          uses: google-github-actions/setup-gcloud@v2
          with:
            project_id: notely-460519

        - name: Use gcloud CLI
          run: gcloud info

        - name: Upload to GCP
          run: gcloud builds submit --tag us-central1-docker.pkg.dev/notely-460519/notely-ar-repo/jaisonv/notely:latest .